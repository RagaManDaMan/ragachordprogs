<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raga & Mode Studio</title>
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; --success: #10b981; --info: #6366f1; --gold: #b45309; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); padding: 20px; color: #1e293b; margin: 0; }
        .container { max-width: 1000px; margin: 20px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        /* Raga Header Style */
        .raga-id-box { background: #fffbeb; border: 2px solid #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .raga-name { color: var(--gold); font-size: 1.8rem; font-weight: 800; display: block; margin-bottom: 5px; }
        .mode-alias { color: #92400e; font-style: italic; font-size: 1.1rem; display: block; margin-bottom: 10px; }
        .raga-details { font-size: 0.9rem; color: #b45309; background: #fef3c7; padding: 4px 12px; border-radius: 20px; display: inline-block; }

        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; background: #f1f5f9; padding: 20px; border-radius: 8px; }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: bold; font-size: 0.9rem; color: var(--primary); }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 16px; width: 100%; box-sizing: border-box; }
        
        .btn-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; text-decoration: none; font-size: 14px; text-align: center; flex: 1; min-width: 150px; }
        .print-btn { background: var(--success); }
        .lookup-btn { background: var(--info); }

        .table-wrapper { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; background: white; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: var(--primary); color: white; padding: 14px; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 14px; border-bottom: 1px solid #e2e8f0; font-family: 'monospace'; font-size: 15px; }
        .tag { background: #e0f2fe; color: #0369a1; padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }

        @media print { .controls, .btn-row, h2 { display: none !important; } .container { box-shadow: none; border: none; margin: 0; padding: 0; } }
    </style>
</head>
<body>

<div class="container">
    <div class="raga-id-box">
        <span class="raga-name" id="detectedRaga">Loading...</span>
        <span class="mode-alias" id="modeAlias">Common Name Lookup</span>
        <span class="raga-details" id="ianRingID">Scale Integer: --</span>
    </div>

    <div class="controls">
        <div class="input-group">
            <label>1. Shruti (Key Center):</label>
            <select id="keySelect"></select>
        </div>
        <div class="input-group">
            <label>2. Swarasthanas (Notes 1-12):</label>
            <input type="text" id="scaleInput" value="1,3,5,6,8,10,12">
        </div>
        <div class="input-group">
            <label>3. Progression (e.g. 2-5-1):</label>
            <input type="text" id="progSequence" value="2-5-1">
        </div>
    </div>

    <div class="btn-row">
        <button class="btn print-btn" onclick="window.print()">üì• Save PDF Analysis</button>
        <a id="lookupLink" class="btn lookup-btn" target="_blank">üîç View on IanRing.com</a>
    </div>

    <div class="table-wrapper">
        <table id="chordTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // --- DATABASE MAPPING ---
    // Mapping Scale Integers (Ian Ring IDs) to Names
    const scaleLibrary = {
        2741: ["Sankarabharanam", "Major / Ionian"],
        2477: ["Mayamalavagowla", "Double Harmonic Major / Byzantine"],
        1709: ["Kharaharapriya", "Dorian Mode"],
        2749: ["Mechakalyani", "Lydian Mode"],
        1453: ["Hanumatodi", "Phrygian Mode"],
        1389: ["Natabhairavi", "Natural Minor / Aeolian"],
        1701: ["Harikambhoji", "Mixolydian Mode"],
        661: ["Mohanam", "Major Pentatonic"],
        2325: ["Hamsadhwani", "Janya Raga"],
        1161: ["Hindolam", "Minor Pentatonic"],
        1193: ["Sudha Dhanyasi", "Janya Raga"],
        1705: ["Sriranjani", "Janya Raga"],
        657: ["Madhyamavati", "Egyptian / Suspended Pentatonic"],
        293: ["Revati", "Janya Raga"],
        2475: ["Chakravakam", "Mixolydian b6"],
        1387: ["Vachaspati", "Lydian Dominant"]
    };

    const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

    function init() {
        const keySelect = document.getElementById('keySelect');
        notes.forEach((n, i) => {
            let opt = document.createElement('option');
            opt.value = i; opt.text = n;
            keySelect.add(opt);
        });

        document.getElementById('keySelect').addEventListener('change', analyze);
        document.getElementById('scaleInput').addEventListener('input', analyze);
        document.getElementById('progSequence').addEventListener('input', analyze);

        analyze();
    }

    function analyze() {
        const offset = parseInt(document.getElementById('keySelect').value) || 0;
        const scaleVal = document.getElementById('scaleInput').value.replace(/\s/g, '');
        const scaleNums = scaleVal.split(',').map(n => parseInt(n)).filter(n => !isNaN(n));
        const progNums = document.getElementById('progSequence').value.split('-').map(Number).filter(n => n > 0);

        // 1. Calculate Ian Ring Integer
        let binary = 0;
        scaleNums.forEach(n => { if(n>=1 && n<=12) binary += Math.pow(2, n-1); });
        
        // 2. Lookup Names
        const info = scaleLibrary[binary] || ["Custom Scale", "Unknown / Rare Mode"];
        document.getElementById('detectedRaga').innerText = info[0];
        document.getElementById('modeAlias').innerText = info[1];
        document.getElementById('ianRingID').innerText = `Ian Ring Scale ID: ${binary}`;
        document.getElementById('lookupLink').href = `https://ianring.com/musictheory/scales/${binary}`;

        // 3. Logic & Table
        const scaleIndices = scaleNums.map(n => n - 1);
        const transposed = scaleIndices.map(n => (n + offset) % 12).sort((a,b) => a-b);
        
        let headHtml = `<tr><th>Deg.</th><th>Note</th><th>Chord</th>`;
        progNums.forEach(p => { if(p!==1) headHtml += `<th>Prog: ${p}</th>`; });
        document.getElementById('tableHead').innerHTML = headHtml + `</tr>`;

        let bodyHtml = "";
        transposed.forEach((root, i) => {
            let row = `<tr><td><span class="tag">${i + 1}</span></td><td><strong>${notes[root]}</strong></td><td>${getChord(root, transposed)}</td>`;
            progNums.forEach(p => {
                if(p === 1) return;
                const intervals = { 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11 };
                const stepNote = (root + (intervals[p] || 0)) % 12;
                let quality = p === 5 ? "7" : (p === 2 ? "m7" : "maj7");
                row += `<td style="color:var(--accent)">${notes[stepNote]}${quality}</td>`;
            });
            bodyHtml += row + "</tr>";
        });
        document.getElementById('tableBody').innerHTML = bodyHtml;
    }

    function getChord(root, scale) {
        const len = scale.length;
        const pos = scale.indexOf(root);
        const t = scale[(pos + 2) % len];
        const f = scale[(pos + 4) % len];
        const tInt = (t < root ? t + 12 : t) - root;
        const fInt = (f < root ? f + 12 : f) - root;
        
        let name = notes[root];
        if (tInt === 3 && fInt === 7) name += "m";
        else if (tInt === 3 && fInt === 6) name += "dim";
        else if (tInt === 4 && fInt === 8) name += "aug";
        else if (tInt === 4 && fInt === 7) name += "";
        else name += " (alt)";
        return name;
    }

    window.onload = init;
</script>
</body>
</html>
